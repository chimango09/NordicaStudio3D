/**
 * # Core Philosophy
 * This ruleset enforces a multi-tenant security model where each user owns their data. Access to any data—clients, expenses, quotes, etc.—is granted exclusively to the authenticated user who created it. There is no public or cross-user data access.
 *
 * # Data Structure
 * All application data is stored under a top-level `users` collection. Each user's data is then nested within their own document, keyed by their Firebase Authentication UID.
 * - /users/{userId}: The root document for a user.
 * - /users/{userId}/clients/{clientId}: Manages the user's customer information.
 * - /users/{userId}/expenses/{expenseId}: Tracks the user's business expenses.
 * - /users/{userId}/filaments/{filamentId}: Manages the user's 3D printing filament inventory.
 * - /users/{userId}/accessories/{accessoryId}: Manages the user's accessory inventory.
 * - /users/{userId}/quotes/{quoteId}: Stores the user's job quotes.
 * - /users/{userId}/settings/{settingId}: Contains the user's application configuration.
 * - /users/{userId}/trash/{trashId}: Contains the user's soft-deleted documents.
 *
 * # Key Security Decisions
 * - **Strict Ownership**: The primary security principle is that a user can only access documents located under their own user ID (`/users/{request.auth.uid}/...`). This is a non-negotiable rule that isolates user data.
 * - **Authenticated Access Only**: No anonymous access is possible. A user must be signed in to perform any operation.
 * - **No Public or Shared Data**: All collections and documents are private to the owning user.
 * - **Destructive Operation Safety**: Update and delete operations are gated with a check to ensure the document exists before the operation is allowed, preventing writes to null paths.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // User Data Root
    // ------------------------------------------------------------------------
    match /users/{userId} {
      /**
       * @description A user can get their own user document or create it. No one can list, update, or delete user root documents.
       * @allow (get, create) The authenticated user's UID matches the {userId} in the path.
       * @deny (list, update, delete) For all users to prevent enumeration or modification of user profiles.
       */
      allow get, create: if request.auth.uid == userId;
      allow list, update, delete: if false;

      // ------------------------------------------------------------------------
      // Helper Functions (Scoped to user's data)
      // ------------------------------------------------------------------------

      /**
       * Checks if the requesting user is the owner of the document.
       * This is the foundation of the multi-tenant security model.
       */
      function isOwner() {
        return request.auth.uid == userId;
      }
      
      /**
       * Ensures that a user is the owner and that the document they are trying
       * to modify or delete actually exists.
       */
      function isOwnerAndDocExists() {
        return isOwner() && resource != null;
      }


      // ------------------------------------------------------------------------
      // User Sub-Collection Rules
      // ------------------------------------------------------------------------

      /**
       * @description Manages a user's client records.
       * @path /users/{userId}/clients/{clientId}
       * @allow (read, create) A user can read or create clients in their own collection.
       * @allow (update, delete) A user can update or delete existing clients they own.
       * @principle Enforces strict data ownership.
       */
      match /clients/{clientId} {
        allow get, list, create: if isOwner();
        allow update, delete: if isOwnerAndDocExists();
      }

      /**
       * @description Manages a user's expense records.
       * @path /users/{userId}/expenses/{expenseId}
       * @allow (read, create) A user can log or view expenses they own.
       * @principle Enforces strict data ownership.
       */
      match /expenses/{expenseId} {
        allow get, list, create: if isOwner();
        allow update, delete: if isOwnerAndDocExists();
      }

      /**
       * @description Manages a user's filament inventory.
       * @path /users/{userId}/filaments/{filamentId}
       * @allow (read, create) A user can manage their own filament inventory.
       * @principle Enforces strict data ownership.
       */
      match /filaments/{filamentId} {
        allow get, list, create: if isOwner();
        allow update, delete: if isOwnerAndDocExists();
      }
      
      /**
       * @description Manages a user's accessory inventory.
       * @path /users/{userId}/accessories/{accessoryId}
       * @allow (read, create) A user can manage their own accessory inventory.
       * @principle Enforces strict data ownership.
       */
      match /accessories/{accessoryId} {
        allow get, list, create: if isOwner();
        allow update, delete: if isOwnerAndDocExists();
      }

      /**
       * @description Manages a user's quotes.
       * @path /users/{userId}/quotes/{quoteId}
       * @allow (read, create) A user can manage their own quotes.
       * @principle Enforces strict data ownership.
       */
      match /quotes/{quoteId} {
        allow get, list, create: if isOwner();
        allow update, delete: if isOwnerAndDocExists();
      }

      /**
       * @description Manages a user's application settings.
       * @path /users/{userId}/settings/{settingId}
       * @allow (read, create) A user can manage their own settings.
       * @principle Enforces strict data ownership.
       */
      match /settings/{settingId} {
        allow get, list, create: if isOwner();
        allow update, delete: if isOwnerAndDocExists();
      }

      /**
       * @description Manages a user's soft-deleted documents.
       * @path /users/{userId}/trash/{trashId}
       * @allow (read, create) A user can manage their own trash.
       * @principle Enforces strict data ownership.
       */
      match /trash/{trashId} {
        allow get, list, create: if isOwner();
        allow update, delete: if isOwnerAndDocExists();
      }
    }
  }
}
